<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard | Reddit Sentiment</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --accent: rgba(120,255,220,0.35);
      --glass: rgba(0,40,40,0.45);
      --border: rgba(0,255,200,0.12);
      --text: #e7fbff;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg,#003b3b 0%, #001d1d 100%);
      color: var(--text);
      overflow-x: hidden;
      overflow-y: hidden;

      /* NORMAL default state */
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }

    /* WHEN NAVIGATING FROM LOGIN */
    body.deepsea-pre {
      opacity: 0;
      transform: translateY(60vh);
      filter: blur(12px);
    }

    body.deepsea-anim {
      transition:
        transform 1s cubic-bezier(.22,.9,.32,1),
        opacity 1s ease,
        filter 1s ease;
    }

    /* particles */
    .deepsea-particles {
      position: fixed; inset: 0;
      pointer-events: none;
      z-index: 1;
      opacity: .4;
      background-image:
        radial-gradient(circle at 15% 30%, rgba(120,255,220,0.12), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(120,255,220,0.10), transparent 60%),
        radial-gradient(circle at 45% 50%, rgba(120,255,220,0.08), transparent 60%);
      animation: drift 22s linear infinite;
    }

    @keyframes drift {
      from { background-position: 0 0; }
      to   { background-position: 0 300px; }
    }

    /* glow */
    .rays {
      position: fixed; inset: 0;
      animation: pulse 7s ease-in-out infinite;
      background: radial-gradient(circle at 50% 25%, rgba(120,255,220,0.08), transparent 70%);
      mix-blend-mode: overlay;
      z-index: 2;
    }

    @keyframes pulse {
      0%,100% { opacity:.3 }
      50%     { opacity:.75 }
    }

    .card {
      background: var(--glass);
      border: 1.5px solid var(--border);
      border-radius: 18px;
      backdrop-filter: blur(14px) saturate(160%);
      box-shadow: 0 0 20px rgba(0,255,200,0.12), inset 0 0 12px rgba(0,255,200,0.06);
    }

  </style>
</head>

<body>

  <div class="deepsea-particles"></div>
  <div class="rays"></div>

  <div class="container" style="margin-top: 40px; position: relative; z-index: 5;">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>
        {% if session['user'] == 'reddit' %}
          Reddit Feed Analysis
        {% else %}
          Your Sentiment Dashboard
        {% endif %}
      </h2>
      <div>
        <button class="btn btn-sm btn-info me-2" onclick="updateDashboard()">Refresh</button>
        <a class="btn btn-sm btn-secondary" href="{{ url_for('logout') }}">Logout</a>
      </div>
    </div>

    {% if session['user'] != 'reddit' %}
    <div class="card p-4 mb-4">
      <form method="POST" action="/analyze" class="d-flex gap-2">
        <textarea name="text" rows="3" class="form-control" placeholder="Enter text..." required></textarea>
        <div class="d-flex flex-column">
          <button class="btn btn-success mb-2" type="submit">Analyze</button>
          <button class="btn btn-outline-light" type="button" onclick="updateDashboard()">Refresh Chart</button>
        </div>
      </form>
    </div>
    {% endif %}

    <div class="row">
      <div class="col-md-6">
        <h5>Sentiment Distribution</h5>
        <canvas id="sentimentChart" width="400" height="300"></canvas>
      </div>

      <div class="col-md-6">
        <h5 class="mb-2">
          {% if session['user'] == 'reddit' %}
            Latest Reddit Posts  
          {% else %}
            Your History
          {% endif %}
        </h5>

        <div class="table-responsive" style="max-height:360px; overflow:auto;">
          <table class="table table-dark table-striped">
            <thead>
              <tr><th>Text</th><th>Sentiment</th><th>Polarity</th></tr>
            </thead>
            <tbody id="historyBody">
              {% for sentence, sentiment, polarity in history %}
              <tr>
                <td style="max-width:320px; white-space:normal;">{{ sentence }}</td>
                <td>{{ sentiment }}</td>
                <td>{{ "%.3f"|format(polarity) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>


<script>
let chart;

async function fetchSummary() {
  try {
    const r = await fetch('/api/summary');
    return r.ok ? await r.json() : { Positive:0, Negative:0, Neutral:0 };
  } catch {
    return { Positive:0, Negative:0, Neutral:0 };
  }
}

async function updateHistory() {
  const r = await fetch(window.location.href);
  const doc = new DOMParser().parseFromString(await r.text(), "text/html");
  document.querySelector("#historyBody").innerHTML =
    doc.querySelector("#historyBody").innerHTML;
}

async function drawChart() {
  const d = await fetchSummary();
  const ctx = document.getElementById('sentimentChart');

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Positive', 'Negative', 'Neutral'],
      datasets: [{
        data: [d.Positive, d.Negative, d.Neutral],
        backgroundColor: ['#4fe3ff','#ff4e4e','#ffd24c']
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks:{color:"#fff"} },
        y: { ticks:{color:"#fff"} }
      }
    }
  });
}

async function updateDashboard() {
  await drawChart();
  await updateHistory();
}

setInterval(updateDashboard, 60000);
updateDashboard();


/* REAL SMOOTH LOGIN â†’ DASHBOARD TRANSITION */
window.addEventListener("DOMContentLoaded", () => {
  const fromLogin = sessionStorage.getItem("deepsea_login") === "true";
  sessionStorage.removeItem("deepsea_login");

  if (!fromLogin) return;

  document.body.classList.add("deepsea-pre");

  requestAnimationFrame(() => {
    document.body.classList.add("deepsea-anim");
    document.body.classList.remove("deepsea-pre");
  });
});
</script>

</body>
</html>
